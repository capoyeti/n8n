{
  "id": "9Qt8i2u3PPRkcIwK",
  "name": "Clever Connections - Incoming Message Handler",
  "active": true,
  "nodes": [
    {
      "id": "webhook",
      "name": "WhatsApp Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        250,
        300
      ],
      "parameters": {
        "path": "whatsapp-incoming",
        "httpMethod": "POST",
        "responseMode": "onReceived",
        "responseCode": 200
      },
      "webhookId": "whatsapp-incoming"
    },
    {
      "id": "extract_data",
      "name": "Extract Message Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        450,
        300
      ],
      "parameters": {
        "jsCode": "// Extract data from Evolution API webhook payload\nconst webhookPayload = $input.first().json;\n// Handle n8n webhook structure - data is in body\nconst payload = webhookPayload.body || webhookPayload;\n\n// Handle different message types from Evolution API\nlet messageText = '';\nlet senderPhone = '';\nlet messageId = '';\nlet timestamp = '';\nlet isFromMe = false;\n\n// Check if this is an incoming message event\nif (payload.event === 'messages.upsert' && payload.data) {\n  const data = payload.data;\n  const key = data.key || {};\n  const message = data.message || {};\n  \n  // Extract phone number (remove @s.whatsapp.net suffix)\n  const remoteJid = key.remoteJid || '';\n  senderPhone = remoteJid.replace('@s.whatsapp.net', '').replace('@g.us', '');\n  \n  // Check if message is from us (outgoing) - skip if so\n  isFromMe = key.fromMe || false;\n  \n  messageId = key.id || '';\n  timestamp = data.messageTimestamp ? new Date(data.messageTimestamp * 1000).toISOString() : new Date().toISOString();\n  \n  // Extract message text from various message types\n  if (message.conversation) {\n    messageText = message.conversation;\n  } else if (message.extendedTextMessage?.text) {\n    messageText = message.extendedTextMessage.text;\n  } else if (message.imageMessage?.caption) {\n    messageText = '[Image] ' + (message.imageMessage.caption || '');\n  } else if (message.videoMessage?.caption) {\n    messageText = '[Video] ' + (message.videoMessage.caption || '');\n  } else if (message.documentMessage?.caption) {\n    messageText = '[Document] ' + (message.documentMessage.caption || '');\n  } else if (message.audioMessage) {\n    messageText = '[Audio Message]';\n  } else {\n    messageText = '[Unknown message type]';\n  }\n}\n\n// Only process incoming messages (not our own)\nif (isFromMe || !senderPhone || !messageText) {\n  return []; // Skip this message\n}\n\nreturn [{\n  json: {\n    phone: senderPhone,\n    message: messageText,\n    message_id: messageId,\n    timestamp: timestamp,\n    raw_event: payload.event\n  }\n}];"
      }
    },
    {
      "id": "lookup_lead",
      "name": "Find Lead by Phone",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        650,
        300
      ],
      "parameters": {
        "operation": "read",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "16Ys4nkLyfJapuy_hS-mzOZP5Srw65NqnmJ6UzCD9bk0"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "leads"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "phone_normalized",
              "lookupValue": "={{ $json.phone }}"
            }
          ]
        },
        "options": {
          "dataLocationOnSheet": {
            "rangeDefinition": "detectAutomatically"
          }
        },
        "range": "A:Z"
      },
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "EMycuXif3kCAGGin",
          "name": "Clever Assets Google Sheets"
        }
      }
    },
    {
      "id": "check_lead_found",
      "name": "Lead Found?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        850,
        300
      ],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "condition1",
              "leftValue": "={{ $json.email }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ]
        }
      }
    },
    {
      "id": "analyze_sentiment",
      "name": "Analyze Sentiment",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1050,
        200
      ],
      "parameters": {
        "jsCode": "// Get message from previous extract node and lead data\nconst extractData = $('Extract Message Data').first().json;\nconst leadData = $input.first().json;\nconst message = extractData.message.toLowerCase();\n\n// Sentiment keywords\nconst notInterestedKeywords = ['stop', 'no', 'not interested', 'unsubscribe', 'remove', 'dont contact', \"don't contact\", 'leave me alone', 'no thanks', 'no thank you'];\nconst interestedKeywords = ['yes', 'interested', 'tell me more', 'please contact', 'call me', 'more info', 'sounds good', 'sign me up', 'i want', \"i'd like\", 'im interested', \"i'm interested\"];\nconst confusedKeywords = ['?', 'what', 'who is this', 'wrong number', 'who are you', 'what is this', 'huh', 'confused'];\n\nlet sentiment = 'neutral';\nlet newStatus = leadData.campaign_status || 'sent';\nlet needsHuman = leadData.needs_human === 'TRUE';\n\n// Check for not interested\nfor (const keyword of notInterestedKeywords) {\n  if (message.includes(keyword)) {\n    sentiment = 'not_interested';\n    newStatus = 'not_interested';\n    break;\n  }\n}\n\n// Check for interested (if not already marked as not interested)\nif (sentiment === 'neutral') {\n  for (const keyword of interestedKeywords) {\n    if (message.includes(keyword)) {\n      sentiment = 'interested';\n      newStatus = 'interested';\n      needsHuman = true; // Dom should follow up\n      break;\n    }\n  }\n}\n\n// Check for confused (if still neutral)\nif (sentiment === 'neutral') {\n  for (const keyword of confusedKeywords) {\n    if (message.includes(keyword)) {\n      sentiment = 'confused';\n      needsHuman = true; // Dom should clarify\n      break;\n    }\n  }\n}\n\nreturn [{\n  json: {\n    // Message data\n    phone: extractData.phone,\n    message: extractData.message,\n    message_id: extractData.message_id,\n    timestamp: extractData.timestamp,\n    // Lead data\n    lead_id: leadData.id,\n    lead_email: leadData.email,\n    first_name: leadData.first_name,\n    last_name: leadData.last_name,\n    business_name: leadData.business_name,\n    // Analysis results\n    sentiment: sentiment,\n    new_status: newStatus,\n    needs_human: needsHuman ? 'TRUE' : 'FALSE',\n    should_alert_dom: sentiment === 'interested' || sentiment === 'confused'\n  }\n}];"
      }
    },
    {
      "id": "log_message",
      "name": "Log to Messages Sheet",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        1250,
        200
      ],
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "16Ys4nkLyfJapuy_hS-mzOZP5Srw65NqnmJ6UzCD9bk0"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "messages"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $json.message_id }}",
            "lead_id": "={{ $json.lead_id }}",
            "phone": "={{ $json.phone }}",
            "direction": "inbound",
            "content": "={{ $json.message }}",
            "sentiment": "={{ $json.sentiment }}",
            "is_automated": "FALSE",
            "sent_by": "",
            "timestamp": "={{ $json.timestamp }}"
          },
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "phone",
              "displayName": "phone",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "direction",
              "displayName": "direction",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "content",
              "displayName": "content",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "sentiment",
              "displayName": "sentiment",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "is_automated",
              "displayName": "is_automated",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "sent_by",
              "displayName": "sent_by",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "removed": false
            }
          ]
        },
        "options": {}
      },
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "EMycuXif3kCAGGin",
          "name": "Clever Assets Google Sheets"
        }
      }
    },
    {
      "id": "update_lead",
      "name": "Update Lead Status",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        1450,
        200
      ],
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "16Ys4nkLyfJapuy_hS-mzOZP5Srw65NqnmJ6UzCD9bk0"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "leads"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "email": "={{ $json.lead_email }}",
            "campaign_status": "={{ $json.new_status }}",
            "last_response": "={{ $json.timestamp }}",
            "needs_human": "={{ $json.needs_human }}"
          },
          "matchingColumns": [
            "email"
          ],
          "schema": [
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": true,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "campaign_status",
              "displayName": "campaign_status",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "last_response",
              "displayName": "last_response",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "needs_human",
              "displayName": "needs_human",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "removed": false
            }
          ]
        },
        "options": {
          "dataLocationOnSheet": {
            "rangeDefinition": "detectAutomatically"
          }
        }
      },
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "EMycuXif3kCAGGin",
          "name": "Clever Assets Google Sheets"
        }
      }
    },
    {
      "id": "check_alert",
      "name": "Alert Admin?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1650,
        200
      ],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "alert_condition",
              "leftValue": "={{ $('Analyze Sentiment').first().json.should_alert_dom }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      }
    },
    {
      "id": "send_dom_alert",
      "name": "Alert Admin via WhatsApp",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1850,
        100
      ],
      "parameters": {
        "method": "POST",
        "url": "http://159.223.23.22:8080/message/sendText/n8n-whatsapp",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "EVO_ae4f6e1250e3330e5e6bca56532bfa2a"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"number\": \"27767186271\",\n  \"text\": \"üîî {{ $('Analyze Sentiment').first().json.sentiment === 'interested' ? 'INTERESTED' : 'NEEDS ATTENTION' }} lead!\\n\\nüë§ {{ $('Analyze Sentiment').first().json.first_name }} {{ $('Analyze Sentiment').first().json.last_name }}\\nüè¢ {{ $('Analyze Sentiment').first().json.business_name }}\\nüì± {{ $('Analyze Sentiment').first().json.phone }}\\n\\nüí¨ Their message:\\n{{ $('Analyze Sentiment').first().json.message }}\"\n}"
      }
    },
    {
      "id": "unknown_sender",
      "name": "Log Unknown Sender",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1050,
        400
      ],
      "parameters": {
        "jsCode": "// Log that we received a message from an unknown number\nconst extractData = $('Extract Message Data').first().json;\n\nconsole.log('Message from unknown sender:', extractData.phone);\nconsole.log('Message:', extractData.message);\n\nreturn [{\n  json: {\n    status: 'unknown_sender',\n    phone: extractData.phone,\n    message: extractData.message,\n    note: 'Sender not found in leads database'\n  }\n}];"
      }
    },
    {
      "id": "log_to_datatable",
      "name": "Log to Data Table (Fast)",
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        550,
        500
      ],
      "parameters": {
        "operation": "insert",
        "dataTableId": {
          "__rl": true,
          "mode": "list",
          "value": ""
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "message_id": "={{ $json.message_id }}",
            "phone": "={{ $json.phone }}",
            "message": "={{ $json.message }}",
            "timestamp": "={{ $json.timestamp }}",
            "direction": "inbound",
            "synced_to_sheets": "FALSE"
          },
          "matchingColumns": [],
          "schema": []
        },
        "options": {}
      },
      "disabled": true
    }
  ],
  "connections": {
    "WhatsApp Webhook": {
      "main": [
        [
          {
            "node": "Extract Message Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Message Data": {
      "main": [
        [
          {
            "node": "Find Lead by Phone",
            "type": "main",
            "index": 0
          },
          {
            "node": "Log to Data Table (Fast)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Lead by Phone": {
      "main": [
        [
          {
            "node": "Lead Found?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lead Found?": {
      "main": [
        [
          {
            "node": "Analyze Sentiment",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Unknown Sender",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Sentiment": {
      "main": [
        [
          {
            "node": "Log to Messages Sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log to Messages Sheet": {
      "main": [
        [
          {
            "node": "Update Lead Status",
            "type": "main",
            "index": 0
          },
          {
            "node": "Alert Admin?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Alert Admin?": {
      "main": [
        [
          {
            "node": "Alert Admin via WhatsApp",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "tags": [],
  "staticData": null,
  "meta": {},
  "pinData": {}
}